parameters:
  buildConfig: ''
  archType: ''
  osGroup: ''
  priority: 0
  crossgen: false
  scenarios: ''
  name: ''
  displayName: ''

### Test job

### Each test job depends on a corresponding testbuild job with the same
### buildConfig and archType.

jobs:
- template: xplat-job.yml
  parameters:
    buildConfig: ${{ parameters.buildConfig }}
    archType: ${{ parameters.archType }}
    osGroup: ${{ parameters.osGroup }}

    # Compute job name from template parameters
    ${{ if eq(parameters.crossgen, 'false') }}:
      name: ${{ format('test_{0}_{1}_{2}_{3}', parameters.name, parameters.osGroup, parameters.archType, parameters.buildConfig) }}
      displayName: ${{ format('Test {0} {1} {2} {3}', parameters.displayName, parameters.osGroup, parameters.archType, parameters.buildConfig) }}
    ${{ if eq(parameters.crossgen, 'true') }}:
      name: ${{ format('test_r2r_{0}_{1}_{2}_{3}', parameters.name, parameters.osGroup, parameters.archType, parameters.buildConfig) }}
      displayName: ${{ format('Test R2R {0} {1} {2} {3}', parameters.displayName, parameters.osGroup, parameters.archType, parameters.buildConfig) }}

    variables:
      # Map template parameters to command line arguments
      ${{ if eq(parameters.priority, '1') }}:
        ${{ if or(eq(parameters.osGroup, 'Linux'), eq(parameters.osGroup, 'OSX')) }}:
          priorityArg: 'priority1'
        ${{ if eq(parameters.osGroup, 'Windows_NT') }}:
          priorityArg: '-priority=1'
      ${{ if eq(parameters.priority, '0') }}:
        priorityArg: ''

      ${{ if eq(parameters.crossgen, 'true') }}:
        crossgenArg: 'crossgen'
      ${{ if eq(parameters.crossgen, 'false') }}:
        crossgenArg: ''
      ${{ if ne(parameters.scenarios, '') }}:
        scenariosArg: ${{ format('/p:Scenarios=\"{0}\"', parameters.scenarios) }}
      ${{ if eq(parameters.scenarios, '') }}:
        scenariosArg: ''

    # Test job depends on the corresponding testbuild job
    ${{ if eq(parameters.crossgen, 'false') }}:
      dependsOn: ${{ format('testbuild_pri{0}_{1}_{2}_{3}', parameters.priority, parameters.osGroup, parameters.archType, parameters.buildConfig) }}
    ${{ if eq(parameters.crossgen, 'true') }}:
      dependsOn: ${{ format('testbuild_pri{0}_r2r_{1}_{2}_{3}', parameters.priority, parameters.osGroup, parameters.archType, parameters.buildConfig) }}

    steps:

    # Initialize tools
    - ${{ if or(eq(parameters.osGroup, 'Linux'), eq(parameters.osGroup, 'OSX')) }}:
      - script: ./init-tools.sh
        displayName: Initialize tools
    - ${{ if eq(parameters.osGroup, 'Windows_NT') }}:
      - script: init-tools.cmd
        displayName: Initialize tools

    # Download test build from pipeline artifact storage
    - ${{ if or(eq(parameters.osGroup, 'Linux'), eq(parameters.osGroup, 'OSX')) }}:
      - task: DownloadPipelineArtifact@0
        displayName: Download product build pipeline artifact
        inputs:
          ${{ if eq(parameters.crossgen, 'false') }}:
            artifactName: ${{ format('testbuild_pri{0}_{1}_{2}_{3}', parameters.priority, parameters.osGroup, parameters.archType, parameters.buildConfig) }}
          ${{ if eq(parameters.crossgen, 'true') }}:
            artifactName: ${{ format('testbuild_pri{0}_r2r_{1}_{2}_{3}', parameters.priority, parameters.osGroup, parameters.archType, parameters.buildConfig) }}
          targetPath: $(Build.SourcesDirectory)/bin/tests/$(osGroup).$(archType).$(buildConfigUpper)/archive
    - ${{ if eq(parameters.osGroup, 'Windows_NT') }}:
      - task: DownloadPipelineArtifact@0
        displayName: Download product build pipeline artifact
        inputs:
          ${{ if eq(parameters.crossgen, 'false') }}:
            artifactName: ${{ format('testbuild_pri{0}_{1}_{2}_{3}', parameters.priority, parameters.osGroup, parameters.archType, parameters.buildConfig) }}
          ${{ if eq(parameters.crossgen, 'true') }}:
            artifactName: ${{ format('testbuild_pri{0}_r2r_{1}_{2}_{3}', parameters.priority, parameters.osGroup, parameters.archType, parameters.buildConfig) }}
          targetPath: $(Build.SourcesDirectory)\bin\tests\Windows_NT.$(archType).$(buildConfigUpper)\archive

    # Send tests to helix
    - ${{ if or(eq(parameters.osGroup, 'Linux'), eq(parameters.osGroup, 'OSX')) }}:
      - script: ./Tools/dotnetcli/dotnet msbuild tests/helixpublishwitharcade.proj /t:SubmitTestsToHelix $(scenariosArg)
        displayName: Send test jobs to Helix
        env:
          ${{ if eq(variables['System.TeamProject'], 'internal') }}:
            # Access token variable for internal project
            HelixAccessToken: $(HelixApiAccessToken)
          ${{ if eq(variables['System.TeamProject'], 'public') }}:
            # Access token variable for public project
            HelixAccessToken: $(BotAccount-dotnet-github-anon-kaonashi-bot-helix-token)
    - ${{ if eq(parameters.osGroup, 'Windows_NT') }}:
      - script: .\Tools\dotnetcli\dotnet msbuild tests\helixpublishwitharcade.proj /t:SubmitTestsToHelix $(scenariosArg)
        displayName: Send test jobs to Helix
        env:
          ${{ if eq(variables['System.TeamProject'], 'internal') }}:
            # Access token variable for internal project
            HelixAccessToken: $(HelixApiAccessToken)
          ${{ if eq(variables['System.TeamProject'], 'public') }}:
            # Access token variable for public project
            HelixAccessToken: $(BotAccount-dotnet-github-anon-kaonashi-bot-helix-token)
          SYSTEM_ACCESSTOKEN: $(System.AccessToken)
